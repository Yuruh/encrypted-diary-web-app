language: node_js
node_js:
  - "stable"
services:
  - docker

# Okay this is almost good, one problem remains:
# tags are apposed on a "fake commit", that exists only for PR, so it doesn't appear in git log nor in git describe
# this reinforce the need to run this on merge to master, not on PR creation
#Â so we'll have to parse the commit message, as ugly as it seems.
jobs:
  include:
    - stage: test
      script:
        - echo "Testing stage" && return 0
    - stage: deploy
      script:
        # Installing gawk to get platform agnostic usage of command AWK
        - sudo apt install gawk

        # Computing next tag name based on branch name
        - echo $TRAVIS_COMMIT_MESSAGE
        - export NEXT_TAG=$(./get_next_tag.sh "$TRAVIS_COMMIT_MESSAGE" $(git describe --abbrev=0))
        - echo "Next version = $NEXT_TAG"
        - docker build -t yuruh/encrypted-diary-web-app:$NEXT_TAG .
        - docker login -u yuruh -p $DOCKER_PWD
        - git tag -a $NEXT_TAG -m "$TRAVIS_COMMIT_MESSAGE"
        - git push "https://$GITHUB_TOKEN@github.com/Yuruh/encrypted-diary-web-app.git" --tags
        - docker push yuruh/encrypted-diary-web-app:$NEXT_TAG

stages:
  - name: test
  - name: deploy
    if: branch = master AND type = push